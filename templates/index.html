<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XCOM Strategy AI Simulator</title>
    <style>
        :root {
            --xcom-teal: #00ffd4;
            --xcom-bg: #0a0e14;
            --xcom-card: #151b23;
            --xcom-text: #e0e0e0;
            --xcom-border: #2d333b;
        }

        body {
            background-color: var(--xcom-bg);
            color: var(--xcom-text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 900px;
            width: 100%;
        }

        header {
            border-bottom: 2px solid var(--xcom-teal);
            margin-bottom: 30px;
            padding-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        header h1 {
            color: var(--xcom-teal);
            margin: 0;
            font-size: 24px;
        }

        .control-panel {
            background-color: var(--xcom-card);
            border: 1px solid var(--xcom-border);
            padding: 20px;
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-size: 12px;
            color: var(--xcom-teal);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        select,
        input {
            background-color: var(--xcom-bg);
            border: 1px solid var(--xcom-border);
            color: var(--xcom-text);
            padding: 8px;
            border-radius: 4px;
        }

        button {
            background-color: var(--xcom-teal);
            color: var(--xcom-bg);
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            grid-column: 1 / -1;
            transition: all 0.3s;
        }

        button:hover {
            filter: brightness(1.2);
            box-shadow: 0 0 15px var(--xcom-teal);
        }

        .results-header {
            margin-top: 40px;
            color: var(--xcom-teal);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pod-card {
            background-color: var(--xcom-card);
            border: 1px solid var(--xcom-border);
            border-left: 4px solid var(--xcom-teal);
            padding: 15px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .pod-card h3 {
            margin-top: 0;
            color: var(--xcom-teal);
            font-size: 14px;
            text-transform: uppercase;
        }

        .pod-stat {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .pod-main {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            display: block;
        }

        .pod-support {
            color: #888;
            font-size: 12px;
        }

        .pod-leader {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 4px;
        }

        .mission-info {
            background: rgba(0, 255, 212, 0.05);
            padding: 15px;
            border-radius: 4px;
            border: 1px dashed var(--xcom-teal);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .pod-card.leader-pod {
            border-left: 4px solid #ff0055;
            box-shadow: inset 0 0 15px rgba(255, 0, 85, 0.1);
        }

        .pod-card.leader-pod h3 {
            color: #ff0055;
        }

        .alien-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .alien-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .alien-item:last-child {
            border-bottom: none;
        }

        .alien-name {
            font-size: 14px;
        }

        .alien-name.main-alien {
            color: var(--xcom-teal);
            font-weight: bold;
        }

        .leader-pod .alien-name.main-alien {
            color: #ff0055;
        }

        .alien-count {
            color: #888;
            font-weight: bold;
        }

        .alien-stats {
            font-size: 11px;
            color: #aaa;
            margin: 4px 0;
            display: flex;
            gap: 10px;
        }

        .stat-val {
            color: #eee;
            font-weight: bold;
        }

        .perk-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .perk-tag {
            background: rgba(0, 255, 212, 0.1);
            border: 1px solid rgba(0, 255, 212, 0.3);
            color: var(--xcom-teal);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            text-transform: uppercase;
        }

        .leader-pod .perk-tag {
            background: rgba(255, 0, 85, 0.1);
            border: 1px solid rgba(255, 0, 85, 0.3);
            color: #ff0055;
        }

        .main-nav {
            display: flex;
            background: #0d1219;
            border-bottom: 2px solid var(--xcom-border);
            margin-bottom: 20px;
            width: 100%;
        }

        .nav-tab {
            padding: 15px 30px;
            color: #888;
            text-decoration: none;
            text-transform: uppercase;
            font-weight: bold;
            font-size: 14px;
            border-right: 1px solid var(--xcom-border);
            transition: all 0.2s;
        }

        .nav-tab:hover {
            color: var(--xcom-teal);
            background: rgba(0, 255, 212, 0.05);
        }

        .nav-tab.active {
            color: var(--xcom-bg);
            background: var(--xcom-teal);
        }
    </style>
</head>

<body>
    <div class="main-nav">
        <a href="/" class="nav-tab active">Mission Simulator</a>
        <a href="/editor" class="nav-tab">Config Editor</a>
    </div>

    <div class="container">
        <!-- ... header remains same ... -->
        <header>
            <h1>Mission Intel: Pod Analysis</h1>
        </header>

        <div class="control-panel">
            <!-- ... duplicated from previous for targetContent match ... -->
            <div class="input-group">
                <label for="mission_type">Mission Type</label>
                <select id="mission_type" onchange="updateUI()">
                    <option value="Abduction">Abduction</option>
                    <option value="Terror">Terror</option>
                    <option value="UFO">UFO</option>
                    <option value="Special">Special Mission</option>
                </select>
            </div>

            <div class="input-group">
                <label for="month">Strategic Month</label>
                <select id="month" onchange="updateFromMonth()">
                    <option value="0">March (Month 0)</option>
                    <option value="1">April (Month 1)</option>
                    <option value="2">May (Month 2)</option>
                    <option value="3">June (Month 3)</option>
                    <option value="4">July (Month 4)</option>
                    <option value="5">August (Month 5)</option>
                    <option value="6">September (Month 6)</option>
                    <option value="7">October (Month 7)</option>
                    <option value="8">November (Month 8)</option>
                    <option value="9">December (Month 9)</option>
                    <option value="10">January (Month 10)</option>
                    <option value="11">February (Month 11)</option>
                    <option value="12">Year 2 (Month 12+)</option>
                </select>
            </div>

            <div id="mission_settings"
                style="grid-column: 1 / -1; display: grid; grid-template-columns: 1fr; gap: 20px; border-top: 1px solid var(--xcom-border); padding-top: 15px; margin-top: 10px;">
                <div class="input-group" id="abduction_size_group">
                    <label for="difficulty">Encounter Size</label>
                    <select id="difficulty" onchange="updateUI()">
                        <option value="0">Light</option>
                        <option value="1" selected>Moderate</option>
                        <option value="2">Heavy</option>
                        <option value="3">Swarming</option>
                    </select>
                </div>

                <div id="ufo_settings" style="display: none; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="input-group">
                        <label for="ship_type">Target Ship</label>
                        <select id="ship_type" onchange="updateUI()">
                            <option value="eShip_UFOSmallScout">Small Scout</option>
                            <option value="eShip_UFOLargeScout">Large Scout</option>
                            <option value="eShip_UFOAbductor">Abductor</option>
                            <option value="eShip_UFOSupply" selected>Supply Ship</option>
                            <option value="eShip_UFOBattle">Battleship</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="landed">Status</label>
                        <select id="landed">
                            <option value="true">Landed (Full Crew)</option>
                            <option value="false">Crashed (Survivors)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="input-group" style="grid-column: 1 / -1; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="advanced_mode" onchange="toggleAdvanced()">
                    <span style="color: var(--xcom-teal); font-size: 11px;">Manual Stat Overrides
                        (Research/Resources)</span>
                </label>
            </div>

            <div id="advanced_controls"
                style="display: none; grid-column: 1 / -1; grid-template-columns: repeat(2, 1fr); gap: 20px; border-top: 1px solid var(--xcom-border); margin-top: 10px; padding-top: 15px;">
                <div class="input-group">
                    <label for="research">Exact Research</label>
                    <input type="number" id="research" value="0" min="0">
                </div>

                <div class="input-group">
                    <label for="resources">Alien Resources</label>
                    <input type="number" id="resources" value="0" min="0">
                </div>
            </div>

            <button onclick="rollPods()">Execute Pod Roll</button>
        </div>

        <div id="mission_summary" style="display: none;">
            <div class="mission-info" id="info_box"></div>
            <div class="results-header">
                <h2>Intelligence Report</h2>
                <span id="pod_count"></span>
            </div>
            <div class="pods-grid" id="pods_container"></div>
        </div>
    </div>

    <script>
        function toggleAdvanced() {
            const advanced = document.getElementById('advanced_mode').checked;
            document.getElementById('advanced_controls').style.display = advanced ? 'grid' : 'none';
        }

        function updateFromMonth() {
            if (!document.getElementById('advanced_mode').checked) {
                const month = parseInt(document.getElementById('month').value);
                // Baseline Research = 28 * Month
                document.getElementById('research').value = month * 28;
                // Baseline Resources = 20 + (Month * 15) as a rough heuristic
                document.getElementById('resources').value = 20 + (month * 15);
            }
        }

        function updateUI() {
            const type = document.getElementById('mission_type').value;
            const ufoDiv = document.getElementById('ufo_settings');
            const abductionGroup = document.getElementById('abduction_size_group');
            const diffSelect = document.getElementById('difficulty');

            ufoDiv.style.display = type === 'UFO' ? 'grid' : 'none';
            abductionGroup.style.display = type === 'Abduction' ? 'block' : 'none';

            if (type === 'UFO') {
                const shipTypes = {
                    "eShip_UFOSmallScout": 0,
                    "eShip_UFOLargeScout": 1,
                    "eShip_UFOAbductor": 2,
                    "eShip_UFOSupply": 3,
                    "eShip_UFOBattle": 4
                };
                // When in UFO mode, we force the difficulty value based on ship size
                const shipSize = shipTypes[document.getElementById('ship_type').value];
                // We don't change the select's value because it might not have that option,
                // but we handle it in the rollPods payload logic.
            }
        }

        async function rollPods() {
            const type = document.getElementById('mission_type').value;
            const shipType = document.getElementById('ship_type').value;
            let diffValue = parseInt(document.getElementById('difficulty').value);

            // Special handling for UFO "Difficulty" mapping
            if (type === 'UFO') {
                const shipTypes = {
                    "eShip_UFOSmallScout": 0,
                    "eShip_UFOLargeScout": 1,
                    "eShip_UFOAbductor": 2,
                    "eShip_UFOSupply": 3,
                    "eShip_UFOBattle": 4
                };
                diffValue = shipTypes[shipType];
            }

            const payload = {
                mission_type: type,
                research: document.getElementById('research').value,
                resources: document.getElementById('resources').value,
                difficulty: diffValue,
                landed: document.getElementById('landed').value === 'true',
                ship_type: shipType
            };

            const response = await fetch('/roll', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            displayResults(data);
        }

        function displayResults(data) {
            const summary = document.getElementById('mission_summary');
            const info = document.getElementById('info_box');
            const container = document.getElementById('pods_container');
            const count = document.getElementById('pod_count');

            summary.style.display = 'block';
            count.innerText = `${data.num_pods} PODS DETECTED`;

            info.innerHTML = `
                <strong>STRATEGIC DATA</strong><br>
                Strategic Month: ${data.month} | Research Level: ${data.research} | Resource Pool: ${data.resources}
            `;

            container.innerHTML = '';
            data.pods.forEach(pod => {
                const card = document.createElement('div');
                card.className = `pod-card ${pod.is_leader_pod ? 'leader-pod' : ''}`;

                let leaderHtml = pod.leader_level > 0 ? `<div class="pod-leader">LVL ${pod.leader_level}</div>` : '';
                let alienListHtml = pod.aliens.map(a => `
                    <li class="alien-item" style="flex-direction: column; align-items: start;">
                        <div style="display: flex; justify-content: space-between; width: 100%;">
                            <span class="alien-name ${a.is_main ? 'main-alien' : ''}">${a.name}</span>
                            <span class="alien-count">x${a.count}</span>
                        </div>
                        <div class="alien-stats">
                            <span>HP: <span class="stat-val">${a.hp}</span></span>
                            <span>AIM: <span class="stat-val">${a.aim}</span></span>
                            <span>WILL: <span class="stat-val">${a.will}</span></span>
                        </div>
                        <div class="perk-container">
                            ${a.perks.map(p => `<span class="perk-tag">${p}</span>`).join('')}
                        </div>
                    </li>
                `).join('');

                card.innerHTML = `
                    <h3>Pod ${pod.index} - ${pod.is_leader_pod ? 'COMMANDER' : pod.category}</h3>
                    ${leaderHtml}
                    <ul class="alien-list">
                        ${alienListHtml}
                    </ul>
                `;
                container.appendChild(card);
            });
        }

        // Init baselines
        updateFromMonth();
    </script>
</body>

</html>